#!/bin/bash
cd $(dirname $0)

if [ `whoami` = root ]; then
	echo Run ./update as Git user. >&2
	exit 1
fi

if [ ! -e ~/GITJOIN_AUTOINSTALLED ]; then
	echo ~/GITJOIN_AUTOINSTALLED does not exist - installation was not performed by ./setup >&2
	echo Make sure that you run ./update as Git user >&2
	exit 1
fi

if [ "$1" != no-pull -a -w .git ]; then
    echo Pulling changes
	git pull
	if [ $? != 0 ]; then
	    echo Pull failed. Run "./update no-pull" to skip git pull
	    exit 1
	fi
	echo Chaining to new update script
	exec ./update no-pull
else
	if [ "$1" != no-pull ]; then
	    echo Not doing 'git pull' - not git repository or .git not writeable
	fi
fi

cp -a gitjoin/ webapp/ *.py ~ || exit 1
echo Syncing DB...
~/manage.py syncdb --noinput
~/manage.py evolve --noinput --hint -x || exit 1
echo Collecting static files...
~/manage.py collectstatic --noinput >/dev/null || exit 1
#echo Clearing cache...
#rm -r ~/var/cache/*
echo Regenerating authorized keys...
DJANGO_SETTINGS_MODULE=webapp.settings python -m gitjoin.authorized_keys || exit 1
echo Setting ACL and reloading...
setfacl -R -m u:apache:rx ~/var/static 2>/dev/null || echo "Updating linux ACL failed - do not care if you don't use it."
touch ~/wsgi.py
echo Updated.