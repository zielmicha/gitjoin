#!/bin/bash
# Gitjoin Git Management
# Copyright (C) 2012 Michal Zielinski
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.

function installgit() {
	if [ -e ~/gitjoin ]; then
		echo ~/gitjoin exists - aborting
		exit 1
	fi
	if grep '# autogenerated' ~/.ssh/authorized_keys &>/dev/null; then
	    echo "~/.ssh/authorized_keys contains '# autogenerated'. Consider removing it. "
	    echo "Aborting."
	    exit 1
	fi
	mv ~/.ssh/authorized_keys ~/authorized_keys.custom 2>/dev/null
	touch ~/authorized_keys.custom
	mkdir -p ~/.ssh || exit 1
	mkdir -p ~/var ~/var/tmp ~/var/locks ~/var/cache ~/repos || exit 1
	cp -a gitjoin/ webapp/ *.py ~ || exit 1
	ln -s ~/webapp/wsgi.py ~/wsgi.py


	if [ ! -e .git ]; then
        echo 'Warning! You are not installing gitjoin from cloned source. You won'\''t be able to update!' 2>&1
	else
	    mkdir ~/gitjoin.git || exit 1
	    cp -r .git ~/gitjoin.git/.git || exit 1
	    ( cd ~/gitjoin.git && git checkout -f ) || exit 1
	fi


	bash genconf.sh > ~/config.py
	touch ~/GITJOIN_AUTOINSTALLED

	echo Ok. Now edit $HOME/config.py
}

cd $(dirname $0)

if [ "$(whoami)" = root ]; then
	printf "Enter name of user to create (empty to abort): "
	read username
	if [ "$username" = "" ]; then
		echo Abort.
		exit 1
	fi
	useradd -s /bin/bash $username
	home=`su $username -c 'echo ~'`
	if [ "$home" = "" ]; then
		echo Failed to get home directory of $username.
		exit 1
	fi
	mkdir -p $home || exit
	chown $username $home || exit
	su $username -c "bash $0"
else
	printf "Overwrite %s? (uppercase yes/no): " "$HOME"
	read yesorno

	if [ "$yesorno" = YES ]; then
		echo "Installing..."
		installgit
	else
		echo Cancel.
		exit 1
	fi
fi
